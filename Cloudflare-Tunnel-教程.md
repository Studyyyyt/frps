# Cloudflare Tunnel å†…ç½‘ç©¿é€å®Œæ•´æ•™ç¨‹

## ğŸ“– ç›®å½•
1. [ä»€ä¹ˆæ˜¯ Cloudflare Tunnel](#ä»€ä¹ˆæ˜¯-cloudflare-tunnel)
2. [å‰ç½®å‡†å¤‡](#å‰ç½®å‡†å¤‡)
3. [åˆ›å»º Cloudflare Tunnel](#åˆ›å»º-cloudflare-tunnel)
4. [éƒ¨ç½² cloudflared å®¹å™¨](#éƒ¨ç½²-cloudflared-å®¹å™¨)
5. [é…ç½®æœåŠ¡è·¯ç”±](#é…ç½®æœåŠ¡è·¯ç”±)
6. [ç‰¹æ®Šåº”ç”¨é…ç½®](#ç‰¹æ®Šåº”ç”¨é…ç½®)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
8. [æ—¥å¸¸ç®¡ç†](#æ—¥å¸¸ç®¡ç†)

---

## ä»€ä¹ˆæ˜¯ Cloudflare Tunnel

Cloudflare Tunnelï¼ˆåŸå Argo Tunnelï¼‰æ˜¯ Cloudflare æä¾›çš„å†…ç½‘ç©¿é€æœåŠ¡ï¼š

### âœ… ä¼˜åŠ¿
- **å…è´¹**ï¼šHTTP/HTTPS æœåŠ¡å®Œå…¨å…è´¹
- **æ— éœ€å…¬ç½‘ IP**ï¼šä¸éœ€è¦è´­ä¹°æœåŠ¡å™¨æˆ–å›ºå®š IP
- **è‡ªåŠ¨ HTTPS**ï¼šè‡ªåŠ¨é…ç½® SSL è¯ä¹¦
- **é«˜æ€§èƒ½**ï¼šåˆ©ç”¨ Cloudflare å…¨çƒ CDN åŠ é€Ÿ
- **å®‰å…¨**ï¼šä¸æš´éœ²æºæœåŠ¡å™¨ IPï¼Œé˜² DDoS

### ğŸ¯ é€‚ç”¨åœºæ™¯
- å®¶åº­ NASï¼ˆç¾¤æ™–ã€å¨è”é€šï¼‰å¤–ç½‘è®¿é—®
- Home Assistant æ™ºèƒ½å®¶å±…è¿œç¨‹æ§åˆ¶
- Emby/Jellyfin/Plex åª’ä½“æœåŠ¡å™¨åˆ†äº«
- å¼€å‘æµ‹è¯•ç¯å¢ƒä¸´æ—¶å…¬ç½‘è®¿é—®
- å†…ç½‘æœåŠ¡ç»Ÿä¸€åŸŸåç®¡ç†

### âš ï¸ é™åˆ¶
- **é€šç”¨ TCP/UDP ç›´è¿éœ€ä»˜è´¹**ï¼ˆCloudflare Spectrumï¼‰
- **HTTP/HTTPS æœåŠ¡å…è´¹**ï¼Œé HTTP æœåŠ¡éœ€å®¢æˆ·ç«¯é…åˆï¼ˆAccessï¼‰

---

## å‰ç½®å‡†å¤‡

### 1. åŸŸåè¦æ±‚
- âœ… æ‹¥æœ‰ä¸€ä¸ªåŸŸåï¼ˆå¦‚ `smallcherry.cn`ï¼‰
- âœ… åŸŸåå·²æ‰˜ç®¡åˆ° Cloudflareï¼ˆå…è´¹è´¦å·å³å¯ï¼‰

**åŸŸåæ‰˜ç®¡åˆ° Cloudflare æ­¥éª¤ï¼š**
1. æ³¨å†Œ [Cloudflare è´¦å·](https://dash.cloudflare.com/sign-up)
2. æ·»åŠ åŸŸååˆ° Cloudflare
3. åˆ°åŸŸåæ³¨å†Œå•†ä¿®æ”¹ DNS æœåŠ¡å™¨ä¸º Cloudflare æä¾›çš„åœ°å€
4. ç­‰å¾… DNS ç”Ÿæ•ˆï¼ˆé€šå¸¸ 10-60 åˆ†é’Ÿï¼‰

### 2. ç¯å¢ƒè¦æ±‚
- âœ… ä¸€å°èƒ½è”ç½‘çš„å†…ç½‘æœºå™¨ï¼ˆç¾¤æ™–/Linux/Windows/Macï¼‰
- âœ… æœºå™¨å·²å®‰è£… Docker å’Œ Docker Compose
- âœ… æœºå™¨èƒ½è®¿é—®å†…ç½‘ä¸­éœ€è¦æ˜ å°„çš„æœåŠ¡

---

## åˆ›å»º Cloudflare Tunnel

### æ­¥éª¤ 1ï¼šç™»å½• Cloudflare Zero Trust

1. è®¿é—® [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. å·¦ä¾§èœå•é€‰æ‹© **Zero Trust**ï¼ˆå¦‚æœé¦–æ¬¡ä½¿ç”¨éœ€è¦åˆ›å»ºå›¢é˜Ÿï¼‰
3. å·¦ä¾§èœå•å±•å¼€ **Networks** â†’ ç‚¹å‡» **Tunnels**

### æ­¥éª¤ 2ï¼šåˆ›å»ºæ–°éš§é“

1. ç‚¹å‡»å³ä¸Šè§’ **Create a tunnel** æŒ‰é’®
2. é€‰æ‹© **Cloudflared**ï¼ˆæ¨èæ–¹å¼ï¼‰
3. ç‚¹å‡» **Select Cloudflared**

### æ­¥éª¤ 3ï¼šå‘½åéš§é“

1. åœ¨ **Name your tunnel** é¡µé¢è¾“å…¥éš§é“åç§°ï¼ˆå¦‚ `home-tunnel`ï¼‰
2. ç‚¹å‡» **Save tunnel**

### æ­¥éª¤ 4ï¼šè·å– Token

è¿›å…¥ **Install and run a connector** é¡µé¢ï¼š

1. é€‰æ‹©æ“ä½œç³»ç»Ÿï¼š**Docker**
2. å¤åˆ¶æ˜¾ç¤ºçš„å‘½ä»¤ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
   ```bash
   docker run cloudflare/cloudflared:latest tunnel --no-autoupdate run --token eyJhIjoiXXXXXX...
   ```
3. **é‡è¦**ï¼šå¤åˆ¶å¹¶ä¿å­˜è¿™ä¸ª Tokenï¼ˆ`eyJhIjo...` è¿™ä¸€é•¿ä¸²ï¼‰ï¼Œåé¢ä¼šç”¨åˆ°

---

## éƒ¨ç½² cloudflared å®¹å™¨

### æ–¹å¼ 1ï¼šä½¿ç”¨ docker-composeï¼ˆæ¨èï¼‰

#### 1. åˆ›å»ºé…ç½®æ–‡ä»¶

åœ¨ä½ çš„å·¥ä½œç›®å½•ï¼ˆå¦‚ `/volume1/docker/cloudflared/`ï¼‰åˆ›å»º `docker-compose.yml` æ–‡ä»¶ï¼š

```yaml
version: '3.8'

services:
  cloudflared:
    # Cloudflare å®˜æ–¹é•œåƒ
    image: cloudflare/cloudflared:latest
    
    # å®¹å™¨åç§°
    container_name: cloudflared
    
    # è‡ªåŠ¨é‡å¯ï¼ˆå¼€æœºè‡ªå¯ï¼‰
    restart: unless-stopped
    
    # ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œæ¨¡å¼ï¼ˆè§£å†³å®¹å™¨æ— æ³•è®¿é—®å®¿ä¸»æœºæœåŠ¡çš„é—®é¢˜ï¼‰
    network_mode: host
    
    # å¯åŠ¨å‘½ä»¤ï¼šè¿è¡Œéš§é“ï¼Œç¦ç”¨è‡ªåŠ¨æ›´æ–°ï¼Œä½¿ç”¨ä½ çš„ Token
    command: tunnel --no-autoupdate run --token ä½ çš„Token
```

**âš ï¸ é‡è¦**ï¼šå°† `ä½ çš„Token` æ›¿æ¢ä¸ºä¸Šä¸€æ­¥å¤åˆ¶çš„å®é™… Tokenï¼

#### 2. å¯åŠ¨å®¹å™¨

```bash
# è¿›å…¥é…ç½®æ–‡ä»¶ç›®å½•
cd /volume1/docker/cloudflared/

# å¯åŠ¨å®¹å™¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—ï¼ˆç¡®è®¤è¿æ¥æˆåŠŸï¼‰
docker-compose logs -f cloudflared
```

#### 3. éªŒè¯è¿æ¥çŠ¶æ€

æŸ¥çœ‹æ—¥å¿—ï¼Œå¦‚æœçœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹å†…å®¹è¯´æ˜æˆåŠŸï¼š
```
Connection registered connIndex=0
Connection registered connIndex=1
Connection registered connIndex=2
Connection registered connIndex=3
```

### æ–¹å¼ 2ï¼šä½¿ç”¨ docker run å‘½ä»¤

å¦‚æœä½ ä¸æƒ³ç”¨ docker-composeï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿è¡Œå‘½ä»¤ï¼š

```bash
docker run -d --name cloudflared \
  --restart unless-stopped \
  --network host \
  cloudflare/cloudflared:latest \
  tunnel --no-autoupdate run --token ä½ çš„Token
```

---

## é…ç½®æœåŠ¡è·¯ç”±

### åœ¨ Cloudflare Web ç•Œé¢é…ç½®è·¯ç”±ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1ï¼šè¿›å…¥éš§é“é…ç½®

1. å›åˆ° Cloudflare Zero Trust çš„ **Networks** â†’ **Tunnels**
2. æ‰¾åˆ°ä½ åˆ›å»ºçš„éš§é“ï¼Œç‚¹å‡»éš§é“åç§°è¿›å…¥è¯¦æƒ…
3. é€‰æ‹© **Public Hostname** æ ‡ç­¾é¡µ

#### æ­¥éª¤ 2ï¼šæ·»åŠ è·¯ç”±è§„åˆ™

ç‚¹å‡» **Add a public hostname** æŒ‰é’®ï¼Œå¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **Subdomain** | å­åŸŸå | `emby` |
| **Domain** | ä½ çš„åŸŸåï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰ | `smallcherry.cn` |
| **Path** | è·¯å¾„ï¼ˆå¯é€‰ï¼Œä¸€èˆ¬ç•™ç©ºï¼‰ | ç•™ç©ºæˆ–å¡« `/` |
| **Type** | æœåŠ¡ç±»å‹ | é€‰æ‹© `HTTP` |
| **URL** | å†…ç½‘æœåŠ¡åœ°å€ | `http://192.168.1.21:8096` |

å®Œæ•´è®¿é—®åœ°å€ï¼š`https://emby.smallcherry.cn`

#### ç¤ºä¾‹é…ç½®ï¼š

**ç¤ºä¾‹ 1ï¼šç¾¤æ™– Emby æœåŠ¡**
- Subdomain: `emby`
- Domain: `smallcherry.cn`
- Type: `HTTP`
- URL: `http://192.168.1.21:8096`

**ç¤ºä¾‹ 2ï¼šå±€åŸŸç½‘å†…å…¶ä»–æœºå™¨çš„æœåŠ¡**
- Subdomain: `home`
- Domain: `smallcherry.cn`
- Type: `HTTP`
- URL: `http://192.168.1.62:8123`ï¼ˆè™šæ‹Ÿæœº IPï¼‰

**ç¤ºä¾‹ 3ï¼šç¾¤æ™– DSM ç®¡ç†ç•Œé¢**
- Subdomain: `nas`
- Domain: `smallcherry.cn`
- Type: `HTTP`
- URL: `http://192.168.1.21:5000`

#### æ­¥éª¤ 3ï¼šä¿å­˜å¹¶æµ‹è¯•

1. ç‚¹å‡» **Save** ä¿å­˜é…ç½®
2. ç­‰å¾… 1-2 åˆ†é’Ÿ DNS ç”Ÿæ•ˆ
3. åœ¨æµè§ˆå™¨è®¿é—® `https://your-subdomain.your-domain.com`

### æ³¨æ„äº‹é¡¹

âœ… **IP åœ°å€å¡«å†™è§„åˆ™ï¼š**
- å¦‚æœæœåŠ¡åœ¨**è¿è¡Œ cloudflared çš„åŒä¸€å°æœºå™¨**ä¸Šï¼š
  - å¯ä»¥å¡« `http://localhost:ç«¯å£` æˆ– `http://127.0.0.1:ç«¯å£`
  - ä¹Ÿå¯ä»¥å¡«æœºå™¨çš„å±€åŸŸç½‘ IP
- å¦‚æœæœåŠ¡åœ¨**å±€åŸŸç½‘å†…å…¶ä»–æœºå™¨**ä¸Šï¼š
  - å¡«å†™ç›®æ ‡æœºå™¨çš„å±€åŸŸç½‘ IPï¼Œå¦‚ `http://192.168.1.100:ç«¯å£`
  - ç¡®ä¿è¿è¡Œ cloudflared çš„æœºå™¨èƒ½è®¿é—®åˆ°ç›®æ ‡æœºå™¨

âœ… **ç«¯å£è¯´æ˜ï¼š**
- Cloudflare ä¼šè‡ªåŠ¨æä¾› HTTPSï¼ˆ443 ç«¯å£ï¼‰
- å¤–ç½‘è®¿é—®ï¼š`https://subdomain.domain.com`ï¼ˆä¸éœ€è¦åŠ ç«¯å£å·ï¼‰
- å†…ç½‘æœåŠ¡åœ°å€å¿…é¡»åŒ…å«ç«¯å£å·ï¼ˆé™¤éæ˜¯ 80 ç«¯å£ï¼‰

---

## ç‰¹æ®Šåº”ç”¨é…ç½®

### Home Assistant é…ç½®

Home Assistant æœ‰å®‰å…¨éªŒè¯æœºåˆ¶ï¼Œé€šè¿‡åå‘ä»£ç†è®¿é—®éœ€è¦é¢å¤–é…ç½®ã€‚

#### æ–¹æ³• 1ï¼šCloudflare é…ç½® Host Headerï¼ˆæ¨èï¼‰

åœ¨æ·»åŠ è·¯ç”±è§„åˆ™æ—¶ï¼š

1. å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼ˆSubdomainã€Domainã€URLï¼‰
2. å±•å¼€ **Additional application settings**
3. å±•å¼€ **HTTP Settings**
4. åœ¨ **Host Header** å­—æ®µå¡«å†™ï¼š`192.168.1.62:8123`ï¼ˆä½ çš„ HA å®é™…åœ°å€ï¼‰
5. ç‚¹å‡» **Save**

#### æ–¹æ³• 2ï¼šä¿®æ”¹ Home Assistant é…ç½®

ç¼–è¾‘ Home Assistant çš„ `configuration.yaml` æ–‡ä»¶ï¼Œæ·»åŠ ï¼š

```yaml
http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 192.168.1.21      # è¿è¡Œ cloudflared çš„æœºå™¨ IP
    - 192.168.1.0/24    # æ•´ä¸ªå±€åŸŸç½‘æ®µ
    - 127.0.0.1
    - ::1
```

ä¿å­˜åé‡å¯ Home Assistantã€‚

### ç¾¤æ™– DSM é…ç½®

ç¾¤æ™–ç®¡ç†ç•Œé¢é»˜è®¤å¯ç›´æ¥è®¿é—®ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

**å»ºè®®é…ç½®ï¼š**
- Subdomain: `nas`
- URL: `http://192.168.1.21:5000`ï¼ˆDSM HTTP ç«¯å£ï¼‰
- æˆ–: `https://192.168.1.21:5001`ï¼ˆDSM HTTPS ç«¯å£ï¼Œæ¨èï¼‰

### Emby/Jellyfin/Plex é…ç½®

è¿™äº›åª’ä½“æœåŠ¡å™¨é€šå¸¸æ— éœ€é¢å¤–é…ç½®ï¼Œç›´æ¥æ·»åŠ è·¯ç”±å³å¯ã€‚

**æ³¨æ„**ï¼šå¦‚æœé‡åˆ°è®¿é—®é—®é¢˜ï¼Œæ£€æŸ¥åº”ç”¨çš„ç½‘ç»œè®¾ç½®ï¼Œç¡®ä¿å…è®¸å¤–éƒ¨è®¿é—®ã€‚

---

## å¸¸è§é—®é¢˜

### ğŸ”´ 502 Bad Gateway

**åŸå› ï¼š**
- åç«¯æœåŠ¡æœªè¿è¡Œ
- IP åœ°å€æˆ–ç«¯å£å¡«å†™é”™è¯¯
- é˜²ç«å¢™é˜»æ­¢è®¿é—®
- å®¹å™¨ç½‘ç»œéš”ç¦»é—®é¢˜

**è§£å†³æ–¹æ³•ï¼š**

1. **æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ**ï¼š
   ```bash
   # æµ‹è¯•èƒ½å¦è®¿é—®
   curl http://192.168.1.21:8096
   
   # æ£€æŸ¥ç«¯å£ç›‘å¬
   netstat -tuln | grep 8096
   ```

2. **æ£€æŸ¥ cloudflared æ—¥å¿—**ï¼š
   ```bash
   docker logs cloudflared --tail 50
   ```

3. **å¦‚æœä½¿ç”¨ Docker éƒ¨ç½²ï¼Œæ·»åŠ  `network_mode: host`**ï¼š
   ```yaml
   services:
     cloudflared:
       network_mode: host
   ```

### ğŸ”´ 400 Bad Request

**åŸå› ï¼š**
- åº”ç”¨éªŒè¯ HTTP Host å¤´å¤±è´¥ï¼ˆå¸¸è§äº Home Assistantã€Nextcloudï¼‰

**è§£å†³æ–¹æ³•ï¼š**
- åœ¨ Cloudflare é…ç½® Host Headerï¼ˆè§ä¸Šæ–¹ Home Assistant é…ç½®ï¼‰
- æˆ–åœ¨åº”ç”¨ä¸­é…ç½®ä¿¡ä»»ä»£ç†

### ğŸ”´ å®¹å™¨ä¸€ç›´é‡å¯

**åŸå› ï¼š**
- Token é”™è¯¯æˆ–è¿‡æœŸ
- ç³»ç»Ÿä¸æ”¯æŒæŸäº› Docker é…ç½®å‚æ•°

**è§£å†³æ–¹æ³•ï¼š**

1. **æŸ¥çœ‹æ—¥å¿—å®šä½é—®é¢˜**ï¼š
   ```bash
   docker logs cloudflared
   ```

2. **ç®€åŒ–é…ç½®**ï¼Œç§»é™¤å¯èƒ½ä¸å…¼å®¹çš„å‚æ•°ï¼š
   ```yaml
   version: '3.8'
   services:
     cloudflared:
       image: cloudflare/cloudflared:latest
       container_name: cloudflared
       restart: unless-stopped
       network_mode: host
       command: tunnel --no-autoupdate run --token ä½ çš„Token
   ```

3. **é‡æ–°ç”Ÿæˆ Token**ï¼š
   - åœ¨ Cloudflare åå°åˆ é™¤æ—§éš§é“
   - åˆ›å»ºæ–°éš§é“è·å–æ–° Token

### ğŸ”´ DNS è§£æå¤±è´¥

**åŸå› ï¼š**
- DNS æœªç”Ÿæ•ˆ
- Cloudflare åŸŸåé…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•ï¼š**

1. **æ£€æŸ¥ DNS è®°å½•**ï¼š
   - è¿›å…¥ Cloudflare Dashboard â†’ DNS
   - ç¡®è®¤å­åŸŸåå·²åˆ›å»ºï¼ˆç±»å‹ä¸º CNAMEï¼ŒæŒ‡å‘éš§é“ï¼‰
   - Cloudflare Tunnel é€šå¸¸ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥æ‰‹åŠ¨æ·»åŠ 

2. **ç­‰å¾… DNS ç”Ÿæ•ˆ**ï¼ˆé€šå¸¸ 1-5 åˆ†é’Ÿï¼‰

3. **æµ‹è¯• DNS è§£æ**ï¼š
   ```bash
   nslookup emby.smallcherry.cn
   dig emby.smallcherry.cn
   ```

---

## æ—¥å¸¸ç®¡ç†

### æŸ¥çœ‹å®¹å™¨çŠ¶æ€

```bash
# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
docker ps | grep cloudflared

# æŸ¥çœ‹æ—¥å¿—
docker logs cloudflared -f

# ä½¿ç”¨ docker-compose
docker-compose logs -f cloudflared
```

### é‡å¯å®¹å™¨

```bash
# ç›´æ¥é‡å¯
docker restart cloudflared

# ä½¿ç”¨ docker-compose
docker-compose restart
```

### åœæ­¢å®¹å™¨

```bash
# åœæ­¢å®¹å™¨
docker stop cloudflared

# ä½¿ç”¨ docker-compose
docker-compose down
```

### æ›´æ–°å®¹å™¨

```bash
# ä½¿ç”¨ docker-compose
docker-compose pull
docker-compose up -d

# æˆ–è€…æ‰‹åŠ¨
docker pull cloudflare/cloudflared:latest
docker-compose up -d
```

### æ·»åŠ æ–°çš„æœåŠ¡è·¯ç”±

1. è¿›å…¥ Cloudflare Zero Trust â†’ Networks â†’ Tunnels
2. ç‚¹å‡»éš§é“åç§° â†’ Public Hostname æ ‡ç­¾
3. ç‚¹å‡» **Add a public hostname**
4. å¡«å†™æ–°çš„æœåŠ¡ä¿¡æ¯å¹¶ä¿å­˜
5. **æ— éœ€é‡å¯å®¹å™¨**ï¼Œç«‹å³ç”Ÿæ•ˆ

### ä¿®æ”¹æˆ–åˆ é™¤è·¯ç”±

1. è¿›å…¥éš§é“çš„ Public Hostname é¡µé¢
2. æ‰¾åˆ°è¦ä¿®æ”¹çš„è·¯ç”±ï¼Œç‚¹å‡»å³ä¾§çš„ **Edit** æˆ– **Delete**
3. ä¿®æ”¹åä¿å­˜ï¼Œç«‹å³ç”Ÿæ•ˆ

### æŸ¥çœ‹éš§é“è¿æ¥çŠ¶æ€

åœ¨ Cloudflare Zero Trust â†’ Networks â†’ Tunnels é¡µé¢ï¼š
- **Healthy**ï¼ˆç»¿è‰²ï¼‰ï¼šè¿æ¥æ­£å¸¸
- **Degraded**ï¼ˆé»„è‰²ï¼‰ï¼šéƒ¨åˆ†è¿æ¥å¼‚å¸¸
- **Down**ï¼ˆçº¢è‰²ï¼‰ï¼šéš§é“ç¦»çº¿

---

## æ¶æ„ç¤ºæ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å¤–ç½‘ç”¨æˆ·                                â”‚
â”‚                    https://emby.smallcherry.cn                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloudflare CDNï¼ˆå…¨çƒåŠ é€Ÿï¼‰                    â”‚
â”‚              â€¢ è‡ªåŠ¨ HTTPS è¯ä¹¦                                   â”‚
â”‚              â€¢ éšè—æº IP                                         â”‚
â”‚              â€¢ DDoS é˜²æŠ¤                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Cloudflare Tunnelï¼ˆäº‘ç«¯è·¯ç”±é…ç½®ï¼‰                     â”‚
â”‚              emby.smallcherry.cn â†’ 192.168.1.21:8096            â”‚
â”‚              home.smallcherry.cn â†’ 192.168.1.62:8123            â”‚
â”‚              nas.smallcherry.cn  â†’ 192.168.1.21:5000            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å†…ç½‘ï¼šcloudflared å®¹å™¨                          â”‚
â”‚                  è¿è¡Œåœ¨ç¾¤æ™– 192.168.1.21                         â”‚
â”‚              ï¼ˆé€šè¿‡ docker-compose ç®¡ç†ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Emby    â”‚      â”‚   NAS    â”‚      â”‚   HA     â”‚
   â”‚  :8096   â”‚      â”‚  :5000   â”‚      â”‚  :8123   â”‚
   â”‚ æœ¬æœºæœåŠ¡ â”‚      â”‚ æœ¬æœºæœåŠ¡ â”‚      â”‚ è™šæ‹Ÿæœº   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   192.168.1.21      192.168.1.21      192.168.1.62
```

---

## å®‰å…¨å»ºè®®

### 1. Token å®‰å…¨
- âš ï¸ **ä¸è¦æ³„éœ² Token**ï¼Œä»»ä½•äººæœ‰ Token å°±èƒ½è¿è¡Œä½ çš„éš§é“
- âš ï¸ Token æ³„éœ²åç«‹å³åœ¨ Cloudflare åå°åˆ é™¤éš§é“å¹¶é‡æ–°åˆ›å»º

### 2. åº”ç”¨å®‰å…¨
- âœ… æ‰€æœ‰å…¬å¼€æœåŠ¡**å¿…é¡»è®¾ç½®å¼ºå¯†ç **
- âœ… å¯ç”¨**ä¸¤æ­¥éªŒè¯ï¼ˆ2FAï¼‰**
- âœ… å®šæœŸæ›´æ–°åº”ç”¨ç‰ˆæœ¬ä¿®å¤å®‰å…¨æ¼æ´

### 3. Cloudflare å®‰å…¨é€‰é¡¹
åœ¨ Cloudflare Zero Trust çš„ Access ä¸­å¯ä»¥é…ç½®ï¼š
- **è®¿é—®ç­–ç•¥**ï¼šé™åˆ¶ç‰¹å®š IP æˆ–é‚®ç®±æ‰èƒ½è®¿é—®
- **èº«ä»½éªŒè¯**ï¼šå¼ºåˆ¶é€šè¿‡ Google/GitHub ç­‰ç™»å½•
- **åœ°ç†é™åˆ¶**ï¼šåªå…è®¸ç‰¹å®šå›½å®¶è®¿é—®

### 4. æ—¥å¿—ç›‘æ§
å®šæœŸæ£€æŸ¥ cloudflared æ—¥å¿—ï¼Œç•™æ„å¼‚å¸¸è®¿é—®ï¼š
```bash
docker logs cloudflared --tail 100
```

---

## æˆæœ¬è¯´æ˜

### âœ… å®Œå…¨å…è´¹çš„éƒ¨åˆ†
- Cloudflare Tunnel åŸºç¡€æœåŠ¡
- HTTP/HTTPS æµé‡ï¼ˆæ— é™åˆ¶ï¼‰
- è‡ªåŠ¨ SSL è¯ä¹¦
- CDN åŠ é€Ÿ
- DDoS é˜²æŠ¤ï¼ˆåŸºç¡€ç‰ˆï¼‰

### ğŸ’° éœ€è¦ä»˜è´¹çš„åœºæ™¯
- **Cloudflare Spectrum**ï¼šå…¬ç½‘ç›´è¿ TCP/UDP æœåŠ¡ï¼ˆé HTTPï¼‰ï¼Œçº¦ $10/æœˆèµ·
- **Cloudflare Teams**ï¼šä¼ä¸šçº§è®¿é—®æ§åˆ¶å’Œå®¡è®¡ï¼Œçº¦ $7/ç”¨æˆ·/æœˆ

### å¯¹æ¯” frpï¼ˆä¼ ç»Ÿå†…ç½‘ç©¿é€ï¼‰

| é¡¹ç›® | Cloudflare Tunnel | frp |
|------|-------------------|-----|
| **æˆæœ¬** | å…è´¹ | éœ€è´­ä¹°å…¬ç½‘ IP æœåŠ¡å™¨ï¼ˆçº¦ $5-10/æœˆï¼‰ |
| **é…ç½®éš¾åº¦** | ç®€å•ï¼ˆWeb ç•Œé¢ï¼‰ | ä¸­ç­‰ï¼ˆéœ€é…ç½®æœåŠ¡ç«¯+å®¢æˆ·ç«¯ï¼‰ |
| **æ€§èƒ½** | å…¨çƒ CDN åŠ é€Ÿ | å–å†³äºæœåŠ¡å™¨ä½ç½®å’Œå¸¦å®½ |
| **HTTPS** | è‡ªåŠ¨é…ç½® | éœ€æ‰‹åŠ¨é…ç½®è¯ä¹¦ |
| **å®‰å…¨æ€§** | Cloudflare é˜²æŠ¤ | éœ€è‡ªå·±åŠ å›º |
| **é€‚ç”¨åœºæ™¯** | HTTP/HTTPS ä¸ºä¸» | ä»»æ„ TCP/UDP |

---

## æ€»ç»“

### âœ… Cloudflare Tunnel çš„æœ€ä½³å®è·µ

1. **å®¹å™¨ç®¡ç†**ï¼šä½¿ç”¨ `docker-compose.yml` ç®¡ç†å®¹å™¨
2. **è·¯ç”±é…ç½®**ï¼šä½¿ç”¨ Cloudflare Web ç•Œé¢é…ç½®ï¼ˆå®æ—¶ç”Ÿæ•ˆï¼Œæ˜“ç®¡ç†ï¼‰
3. **å®‰å…¨åŠ å›º**ï¼šå¯ç”¨åº”ç”¨å¯†ç ã€ä¸¤æ­¥éªŒè¯ã€Cloudflare Access
4. **å®šæœŸç»´æŠ¤**ï¼šæ›´æ–°å®¹å™¨é•œåƒã€æ£€æŸ¥æ—¥å¿—ã€ç›‘æ§è¿æ¥çŠ¶æ€

### ğŸ“Œ å…³é”®è¦ç‚¹

- ä¸€ä¸ªéš§é“å¯ä»¥æ˜ å°„**æ— é™ä¸ªæœåŠ¡**
- è·¯ç”±é…ç½®åœ¨ Cloudflare åå°ä¿®æ”¹ï¼Œ**æ— éœ€é‡å¯å®¹å™¨**
- æ”¯æŒåŒä¸€å±€åŸŸç½‘å†…**ä»»æ„æœºå™¨çš„æœåŠ¡**
- å®Œå…¨**å…è´¹**ï¼Œé€‚åˆä¸ªäººå’Œå®¶åº­ä½¿ç”¨

---

## é™„å½•ï¼šå¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨

```bash
# === å®¹å™¨ç®¡ç† ===
# å¯åŠ¨å®¹å™¨
docker-compose up -d

# åœæ­¢å®¹å™¨
docker-compose down

# é‡å¯å®¹å™¨
docker-compose restart

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f cloudflared

# æŸ¥çœ‹çŠ¶æ€
docker ps | grep cloudflared

# === å®¹å™¨æ›´æ–° ===
# æ‹‰å–æœ€æ–°é•œåƒ
docker-compose pull

# é‡æ–°åˆ›å»ºå®¹å™¨
docker-compose up -d

# === æ•…éšœæ’æŸ¥ ===
# æŸ¥çœ‹æœ€è¿‘ 50 è¡Œæ—¥å¿—
docker logs cloudflared --tail 50

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker logs cloudflared -f

# æµ‹è¯•å†…ç½‘æœåŠ¡è¿é€šæ€§
curl http://192.168.1.21:8096

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tuln | grep 8096

# DNS æµ‹è¯•
nslookup emby.smallcherry.cn
```

---

## ç›¸å…³é“¾æ¥

- [Cloudflare Tunnel å®˜æ–¹æ–‡æ¡£](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)
- [Cloudflare Zero Trust Dashboard](https://one.dash.cloudflare.com/)
- [Cloudflare Dashboard](https://dash.cloudflare.com/)
- [Docker Hub - cloudflared](https://hub.docker.com/r/cloudflare/cloudflared)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-02  
**é€‚ç”¨èŒƒå›´**ï¼šä¸ªäºº/å®¶åº­å†…ç½‘ç©¿é€åœºæ™¯

---

ğŸ‰ **æ­å–œä½ å®Œæˆé…ç½®ï¼ç°åœ¨ä½ å¯ä»¥éšæ—¶éšåœ°å®‰å…¨è®¿é—®å®¶ä¸­çš„æœåŠ¡äº†ï¼**

